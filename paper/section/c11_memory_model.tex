The \cc memory model forms an irreflexive and acyclic relation over the events of 
an execution sequence $\tau$ called the {\em happens-before} relation 
($\setHB \subseteq \events_\tau {\times} \events_\tau$);
such that, the execution sequence is {\em coherent} (or valid) under \cc if 
the $\setHB$ relation does not violate any {\em coherence rule} of \cc.
%
The events of a sequence $\tau$ are related by the $\setHB$ as follows;
\begin{itemize}
	\item {\em Intra-thread-hb}: Events of a thread are related by a {\em sequenced-before}
	($\setSB$) relation in the order of occurrence in the thread;
	
	\item {\em Inter-thread-synchronization}: A $\moge$ \acq read event ($ra$) of a thread 
	$t_i$ when reads from a $\moge$ \rel write event $wr$ of another thread $t_j$ they form a
	relation {\em synchronizes-with} ($\setSW$) between them as $\sw{\tau}{wr}{ra}$.
	%
	Further, a $\moge$ \acq read event ($ra$) of a thread $t_i$ when reads from a write 
	event ($w$) in the {\em Release sequence} \cite{C11} of a $\moge$ \rel write event ($wr$) of 
	another thread $t_j$ then $wr$ and $ra$ form a relation {\em dependency-ordered-before}
	($\setDOB$) between them as $\dob{\tau}{wr}{ra}$;
	%
	(where, a release sequence headed by a $\moge$ \rel write event $wr$ is the maximal 
	contiguous sequence, of an execution sequence $\tau$, that starts with $wr$ and continues 
	over write events from the same thread and rmw events or $\moge$ \rel write events from
	other threads.)
	
	\item {\em Inter-thread-hb}: Events from different threads that are related by the 
	transitive closure of ($\setSB$ $\union$ $\setSW$ $\union$ $\setDOB$) are related by 
	the {\em inter-thread-hb} relation ($\setITHB$). 
\end{itemize}

Accordingly, two events $e_1,e_2$ in an execution sequence $\tau$ are happens-before 
related \ie
$\hb{\tau}{e_1}{e_2}$ if $\seqb{\tau}{e_1}{e_2}$ or $\ithb{\tau}{e_1}{e_2}$.
%
Additionally, in a sequence $\tau$, all write events of an object $x$ are related by a 
total order called {\em modification-order} ($\setMO$).
%
The $\setMO$ order is constructed in compliance to a set of coherence
\lmo-rules defined by \cc based on $\setHB$. 
%
The set of $\setMO$ rules are,
\begin{itemize}[label=moWW,align=left,leftmargin=*]
	\item [\hl{moWW}:] $\forall w_1, w_2 \in \writes_\tau$ if $\hb{\tau}{w_1}{w_2}$ then
						$\mo{\tau}{w_1}{w_2}$\newline
						($\setHB$-ordered writes are ordered by $\setMO$);
	\item [\hl{moRR}:] $\forall r_1, r_2 \in \reads_\tau$ \st $\hb{\tau}{r_1}{r_2}$
						and $\exists \rf{\tau}{w_1}{r_1}$
						then $\rf{\tau}{w_1}{r_2}$ $\v$ $\exists \rf{\tau}{w_2}{r_2}$
						and $\mo{\tau}{w_1}{w_2}$\newline
						($\setHB$ between reads forms $\setMO$ between their source
						writes (if they are different events));
	\item [\hl{moRW}:] $\forall r_1 \in \reads_\tau$, $w_1 \in \writes_\tau$ \st
						$\hb{\tau}{r_1}{w_1}$ then $\exists \rf{\tau}{w_2}{r_1}$ and
						$\mo{\tau}{w_2}{w_1}$\newline
						($\setHB$ order from a read to a write forms $\setMO$ between the
						source of the read and the hb-after write);
	\item [\hl{moWR}:] $\forall w_1 \in \writes_\tau$, $r_1 \in \reads_\tau$ \st
						$\hb{\tau}{w_1}{r_1}$ then $\rf{\tau}{w_1}{r_1}$ $\v$
						$\exists \rf{\tau}{w_2}{r_1}$ and $\mo{\tau}{w_1}{w_2}$\newline
						($\setHB$ order from a write to a read forms $\setMO$ between
						the write and the source of the read (if the two are
						different events)).
\end{itemize}

%\begin{figure}[t]
	%	\begin{tabular}{|l m{0.9\textwidth}|}
	%		\hline
	%		\hl{moWW} & $\forall w_1, w_2 \in \writes_\tau$ if $\hb{\tau}{w_1}{w_2}$ then
	%					$\mo{\tau}{w_1}{w_2}$ \\
	%		\hl{moRR} & $\forall r_1, r_2 \in \reads_\tau$ \st $\hb{\tau}{r_1}{r_2}$
	%					and $\exists \rf{\tau}{w_1}{r_1}$
	%					then $\rf{\tau}{w_1}{r_2}$ $\v$ $\exists \rf{\tau}{w_2}{r_2}$
	%					and $\mo{\tau}{w_1}{w_2}$  \\
	%		\hl{moRW} & $\forall r_1 \in \reads_\tau$, $w_1 \in \writes_\tau$ \st
	%					$\hb{\tau}{r_1}{w_1}$ then $\exists \rf{\tau}{w_2}{r_1}$ and
	%					$\mo{\tau}{w_2}{w_1}$ \\
	%		\hl{moWR} & $\forall w_1 \in \writes_\tau$, $r_1 \in \reads_\tau$ \st
	%					$\hb{\tau}{w_1}{r_1}$ then $\rf{\tau}{w_1}{r_1}$ $\v$
	%					$\exists \rf{\tau}{w_2}{r_1}$ and $\mo{\tau}{w_1}{w_2}$ \\
	%		
	%		\hline
	%	\end{tabular}
	
%	\begin{tabular}{|l m{0.86\textwidth}|}
%		\hline
%		\hl{tohb} & $\forall wr^{\sc}_1, wr^{\sc}_2 \in \ordevents{\sc}_\tau$ if 
%		$\hb{\tau}{wr^{\sc}_1}{wr^{\sc}_2}$ 
%		then $\to{\tau}{wr^{\sc}_1}{wr^{\sc}_2}$ \\
%		\hl{toWW} & $\forall w^{\sc}_1, w^{\sc}_2 \in \ordwrites{\sc}_\tau$ if 
%		$\mo{\tau}{w^{\sc}_1}{w^{\sc}_2}$
%		then $\to{\tau}{w^{\sc}_1}{w^{\sc}_2}$ \\
%		\hl{toWR} & $\forall w^{\sc}_1 \in \ordwrites{sc}_\tau$, $r^{\sc}_1 \in 
%		\ordreads{\sc}_\tau$ if $\rf{\tau}{w^{\sc}_1}{r^{\sc}_1}$ then 
%		$\to{\tau}{w^{\sc}_1}{r^{\sc}_1}$ \\
%		\hl{toRW} & $\forall w_1 \in \writes_\tau$, $r^{\sc}_1 \in \ordreads{sc}_\tau$ \st 
%		$\rf{\tau}{w_1}{r^{\sc}_1}$ if $\exists w^{\sc}_2 \in \ordwrites{\sc}_\tau$
%		\st $\mo{\tau}{w_1}{w^{\sc}_2}$ then $\to{\tau}{r^{\sc}_1}{w^{\sc}_2}$ \\
%		\hl{toFW} & $\forall f^{\sc} \in \ordfences{\sc}_\tau$, $w^{\sc}_1 \in 
%		\ordwrites{\sc}_\tau$ if $\exists w_2 \in \writes_\tau$, $r_1 \in 
%		\reads_\tau$ \st $\seqb{\tau}{f^{\sc}}{r_1}$, $\seqb{\tau}{w_2}{w^{\sc}_1}$ 
%		and $\rf{\tau}{w_2}{r_1}$ then $\to{\tau}{f^{\sc}}{w^{\sc}_1}$ \\
%		\hl{toFFrf} & $\forall f^{\sc}_1, f^{\sc}_2 \in \ordfences{\sc}_\tau$, 
%		if $\exists w_1 \in \writes_\tau$, $r_1 \in \reads_\tau$ \st 
%		$\seqb{\tau}{f^{\sc}_1}{w_1}$, $\seqb{\tau}{r_1}{f^{\sc}_2}$ 
%		and $\rf{\tau}{w_1}{r_1}$ then $\to{\tau}{f^{\sc}_1}{f^{\sc}_2}$ \\
%		\hl{toFFnrf} & $\forall f^{\sc}_1, f^{\sc}_2 \in \ordfences{\sc}_\tau$, 
%		if $\exists w_1 \in \writes_\tau$, $r_1 \in \reads_\tau$ \st 
%		$\seqb{\tau}{w_1}{f^{\sc}_1}$, $\seqb{\tau}{f^{\sc}_2}{r_1}$ and
%		$\exists w_2 \in \writes_\tau$ \st $\mo{\tau}{w_2}{w_1}$,
%		$\rf{\tau}{w_2}{r_1}$ then $\to{\tau}{f^{\sc}_2}{f^{\sc}_1}$ \\
%		\hline
%	\end{tabular}
%	\caption{\lmo and \lto coherence rules}
%	\label{fig:mo-to rules}
%\end{figure}

We introduce an irreflexive relation \sc{\em -from-read} ($\setFR$) to relate  
\sc reads with \sc writes ordered {\em after} it.

\begin{definition}[\sc{\em -from-read} $\setFR$]\newline
	$\forall$ $r^\sc \in \ordreads{\sc}_\tau$, $w^\sc \in \ordwrites{\sc}_\tau$
	if $(r^\sc,w^\sc)$ $\in$ $\setRF^{-1};\setMO$ then $\fr{\tau}{r^\sc}{w^\sc}$.
\end{definition}

A valid \cc execution must also form a total order on all events with memory
order \sc, called \sc{\em -total-order} ($\setTO$) \st
\begin{itemize}[label=to,align=left,leftmargin=*]
	\item [\hl{toHbMo}:] $\setTO$ $\implies$ $\nsetHB$ $\^$ $\nsetMO$
			(\sc-total-order is coherent \wrt $\setHB$ and $\setMO$)
	\item [\hl{toFr}:] $\fr{\tau}{r^\sc}{w^\sc}$ $\implies$ $\to{\tau}{r^\sc}{w^\sc}$
			(\sc-total-order is coherent \wrt $\setFR$)
	\item [\hl{toRf}:] if $\exists r^\sc \in \ordreads{\sc}_\tau$ \st
			$\rf{\tau}{w_1}{r^\sc}$ then $\nexists$ $w^\sc \in \ordwrites{\sc}_\tau$
			\st $\to{\tau}{\mo{\tau}{w_1}{w^\sc}}{r^\sc}$.
			(an \sc read must read from its immediate \lmo before write)
\end{itemize}
%

In our technique we use the \lto-rule to build a possibly cyclic
$\setSO$ order between \sc program events and the newly inserted \sc fences.
The cyclicity in the $\setSO$ order invalidates the buggy sequence
under \cc, explained in Section~\ref{sec:so theory}.