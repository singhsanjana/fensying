\begin{figure}[t]
	\begin{tabular}{|c||c|c|c|}
		\multicolumn{1}{c}{base rule} & 
		\multicolumn{3}{c}{extended fence rules} \\\hline
		
		\resizebox{0.24\textwidth}{!}{\input{figures/so_hbmorffr.tex}} &
		\resizebox{0.24\textwidth}{!}{\input{figures/soEF.tex}} &
		\resizebox{0.24\textwidth}{!}{\input{figures/soFE.tex}} &
		\resizebox{0.24\textwidth}{!}{\input{figures/soFF.tex}} \\
		\hline
		\multicolumn{4}{c}{(a) \lso-rules} \\
		\hline
		
		\resizebox{0.24\textwidth}{!}{\input{figures/sw.tex}} &
		\resizebox{0.24\textwidth}{!}{\input{figures/swEF.tex}} &
		\resizebox{0.24\textwidth}{!}{\input{figures/swFE.tex}} &
		\resizebox{0.24\textwidth}{!}{\input{figures/swFF.tex}} \\
		
		\resizebox{0.24\textwidth}{!}{\input{figures/dob.tex}} &
		\resizebox{0.24\textwidth}{!}{\input{figures/dobEF.tex}} &&\\
		\hline
		\multicolumn{4}{c}{(b) \lsw- and \ldob-rules} \\
		\hline
		
		\resizebox{0.24\textwidth}{!}{\input{figures/ws.tex}} &
		\resizebox{0.24\textwidth}{!}{\input{figures/wsEF.tex}} & 
		\resizebox{0.24\textwidth}{!}{\input{figures/wsFE.tex}} &
		\resizebox{0.24\textwidth}{!}{\input{figures/wsFF.tex}} \\
		\hline
		\multicolumn{4}{c}{(c) \lws-rules} \\	
	\end{tabular}
	\caption{Rules to form relation between program events and 
		candidate fences}
	\label{fig:so rules}
\end{figure}

\ourtechnique attempts to invalidate a buggy trace (\aka counter
example) by one of the following two strategies:
\begin{itemize}[label=strategy1,align=left,leftmargin=*]
	\item [Strategy1]:
		Invalidate by violating \sc-\lto-order.
	\item [Strategy2]:
		Invalidate by inter-thread synchronization.
\end{itemize}

\noindent
{\bf Strategy1: Invalidate by violating \sc-\lto-order. 
	(\sfence)}\newline
Consider a buggy input program $P$.
%
As discussed in Section~\ref{sec:c11}, in a valid trace of $P$ 
(including a buggy trace), 
the \sc ordered events must form a total order ($\setTO$).
%
Contrarily, if we synthesize \sc ordered fences in the input program 
such that the total order requirement in the buggy trace gets violated 
then we can invalidate the trace and stop the program behavior.

We introduce an irreflexive and possibly cyclic relation
on \sc ordered events called \sc-order ($\setSO$).
%
To construct $\setSO$, we introduce a set of \lso-rules
(diagrammatically shown in Figure~\ref{fig:so rules}(a) and
discussed below).
%
The \lso base rules are simply implied from
the \lto-rules, \hlref{toHb}, \hlref{toMo} \hlref{toFr} 
and \hlref{toRf} (Section~\ref{sec:c11}).
%
The extended rules apply respective $\lto$-rules to relaxed
events with appropriately placed fences as described in
\cc \cite{C11}\cite{Batty-POPL12}.

\begin{longtable}{|p{0.11\textwidth} p{0.88\textwidth}|}
	\hline
	\multicolumn{2}{|l|}{\bf \lso-base rules:}\\
	
	\hl{sohb}, & 
	$\forall wr^{\sc}_1, wr^{\sc}_2 \in \ordevents{\sc}_\tau$ if \\
	\hl{somo}, &
	$\hb{\tau}{wr^{\sc}_1}{wr^{\sc}_2}$ $\v$ $\mo{\tau}{wr^{\sc}_1}{wr^{\sc}_2}$
	$\v$ $\rf{\tau}{wr^{\sc}_1}{wr^{\sc}_2}$ 
	$\v$ $\fr{\tau}{wr^{\sc}_1}{wr^{\sc}_2}$\\
	\hl{sorf}, & 
	then $\so{\tau}{wr^{\sc}_1}{wr^{\sc}_2}$ \\
	\hl{sofr}: & ($\setHB$, $\setMO$, $\setRF$. $\setFR$ between \sc events 
				implies $\setSO$) \\
	& \\
	
	\multicolumn{2}{|l|}{\bf \lso-rules extended for fences:} \\
	
	\hl{soEF}: & $\forall wr^\sc_1 \in \ordevents{\sc}_\tau$, $f^\sc_1 \in
	\ordfences{\sc}_\tau$ if $\exists wr_2 \in \events_\tau$ \st 
	($\mo{\tau}{wr^\sc_1}{wr_2}$ $\v$ $\hb{\tau}{wr^\sc_1}{wr_2}$
	$\v$ $\rf{\tau}{wr^\sc_1}{wr_2}$) $\^$ $\seqb{\tau}{wr_2}{f^\sc_1}$ 
	then $\so{\tau}{wr^\sc_1}{f^\sc_1}$ \\
	& ($\setHB$, $\setMO$, $\setRF$. $\setFR$ between \sc event and relaxed 
		event forms $\setSO$ with assistance of an appropriately placed 
		fence) \\
	
	\hl{soFE}: & $\forall f^\sc_1 \in \ordfences{\sc}_\tau$, $wr^\sc_2 \in
	\ordevents{\sc}_\tau$ if $\exists wr_1 \in \events_\tau$ \st 
	($\mo{\tau}{wr_1}{wr^\sc_2}$ $\v$ $\hb{\tau}{wr_1}{wr^\sc_2}$
	$\v$ $\rf{\tau}{wr_1}{wr^\sc_2}$) $\^$ $\seqb{\tau}{f^\sc_1}{wr_1}$ 
	then $\so{\tau}{f^\sc_1}{wr^\sc_2}$ \\
	& ($\setHB$, $\setMO$, $\setRF$. $\setFR$ between relaxed event and
	\sc event forms $\setSO$ with assistance of an appropriately placed 
	fence) \\
	
	\hl{soFF}: & $\forall f^{\sc}_1, f^{\sc}_2 \in \ordfences{\sc}_\tau$, 
	if $\exists wr_1, wr_2 \in \events_\tau$ \st 
	($\mo{\tau}{wr_1}{wr_2}$ $\v$ $\hb{\tau}{wr_1}{wr_2}$
	$\v$ $\rf{\tau}{wr_1}{wr_2}$) $\^$
	($\seqb{\tau}{f^{\sc}_1}{wr_1}$, $\seqb{\tau}{wr_2}{f^{\sc}_2}$) 
	then $\so{\tau}{f^{\sc}_1}{f^{\sc}_2}$ \\
	& ($\setHB$, $\setMO$, $\setRF$. $\setFR$ between relaxed events 
		forms $\setSO$ with assistance of appropriately placed fences) \\
	\hline
\end{longtable}
%
Consider a \cc trace $\tau$ and a transformation
$\inv{\tau}$ of $\tau$ \st $\events_{\inv{\tau}}$ = $\events_\tau$
$\union$ set of synthesized fences, then;
%
\begin{theorem} \label{thm:to-so}
	$\to{\inv{\tau}}{}{}$ = (transitive closure of $\so{\inv{\tau}}{}{}$).
\end{theorem}
%
Using Theorem~\ref{thm:to-so} we can state that,
a cyclic $\so{\inv{\tau}}{}{}$ implies that there does not exist a 
total order on \sc ordered events of $\inv{\tau}$. The trace $\inv{\tau}$, 
then, is not a valid \cc trace and the buggy trace $\tau$ 
has been invalidated.
%
Thus, the aim of \sfence is to synthesis fences in the input program $P$
at appropriate locations and force a cyclic $\setSO$ order in the \sc 
ordered events of a buggy trace $\tau$ of $P$ and invalidating the trace 
for the transformed program $\fx{P}$.

\setlength{\textfloatsep}{0pt}
\begin{wrapfigure}{l}{0.5\textwidth}
	\vspace{-2.5em}
	\begin{tabular}{|c|}
		\multicolumn{1}{c}{Initially $Flag_1 = 0, Flag_2 = 0$} \\
		\hline
		\resizebox{0.45\textwidth}{!}{\input{figures/egStrongFence_1.tex}} \\
		\hline
		\resizebox{0.49\textwidth}{!}{\input{figures/egStrongFence_2.tex}} \\
		\hline
		\multicolumn{1}{c}{\hl{mutex}}
	\end{tabular}
	\vspace{-2.5em}
\end{wrapfigure}

Consider the example \hlref{mutex}. If the reads of $Flag_1$ and $Flag_2$ 
read the initial value $0$ (as shown in \hlref{mutex}(i)) 
then the program violates mutual exclusion
property. Note that, the relation $\setFR$ is not a \cc relation, it has
been introduced in this work to assist with forming $\setSO$ relation.
In the absence of $\setFR$, $\setHB$ $\union$ $\setRF$ $\union$ $\setMO$
and $\setTO$ are both acyclic and the trace $\tau$ is possible under \cc.
%
The buggy trace can be invalidated by introducing \sc-fences $\mathbb{F}^\sc_1$
and $\mathbb{F}^\sc_1$ as shown in \hlref{mutex}(ii). The \lso-rules
\hlref{sohb} and \hlref{soFE} (that uses $\setFR$ $\implies$ $\setSO$) can be 
used to construct $\setSO$ edges between 
the program events and synthesized fences to form a cyclic $\setSO$ relation.
The cycle in $\setSO$ relation indicates that a valid total-order cannot
be formed on \sc-events of $\inv{\tau}$ and thus the trace cannot
be produced under \cc.\newline

\noindent
{\bf Strategy2: Invalidate by inter-thread synchronization.
(\wfence)}\newline
As discussed in Section~\ref{sec:c11}, in a valid trace of 
a buggy program $P$ (including a buggy trace), 
the $\setHB \union \setRF \union \setMO$ must be acyclic.
%
In the second strategy we attempt to introduce synchronization
between threads by synthesizing fences. The synchronization
would further introduce $\setITHB$ relation between events
that could stop a buggy behavior by creating a cycle in 
$\setHB \union \setRF \union \setMO$. 
Note that, this strategy invalidates a buggy trace by introducing 
weaker fences (of memory orders \rel, \acq and \acqrel).

\setlength{\textfloatsep}{0pt}
\begin{wrapfigure}{l}{0.6\textwidth}
	\vspace{-2.5em}
	\begin{tabular}{|c|c|}
		\multicolumn{2}{c}{Initially $x = 0, y = 0$} \\
		\hline
		\resizebox{0.29\textwidth}{!}{\input{figures/egWeakFence_1.tex}} &
		\resizebox{0.29\textwidth}{!}{\input{figures/egWeakFence_2.tex}} \\
		\hline
		\multicolumn{2}{c}{\hl{mutex}}
	\end{tabular}
	\vspace{-2.5em}
\end{wrapfigure}


\snj{sc fences alone ensures optimality inno of fences, str 2 needed for opt in type of fences.}
