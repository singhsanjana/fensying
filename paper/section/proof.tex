{\theorem {\wkfence is sound} \label{thm:weak-sound}}
\begin{proof}
	\wkfence strategy checks the validity of coherence conditions
	on event relations between program events and synthesized
	fences.
	
	Given a buggy trace $\tau$, we get the relations $\setHB$,
	$\setRF$, $\setMO$ and $\setRF^{-1}$ from the counter
	example generator.
	(Note that $\setFR$ relation is not invoked by any 
	coherence condition.)
	
	We compute the $\hb{\imm{\tau}}{}{}$ relation after introducing 
	the synthesized fences in the intermediate trace $\imm{\tau}$, 
	hence, the soundness condition can be defined as: 
	\ourtechnique soundly detects all weak cycle without modifying 
	$\setRF$, $\setMO$ and $\setRF^{-1}$ relations for the events of 
	$\imm{\tau}$ (\ie $\rf{\imm{\tau}}{}{} = \setRF$, 
	$\mo{\imm{\tau}}{}{} = \setMO$ and $\rfinv{\imm{\tau}}{}{} = 
	\setRF^{-1}$).
	
	\begin{figure}[h]
		\begin{tabular}{|c|c|c|c|}
			\hline
			\resizebox{0.19\textwidth}{!}{\input{figures/coWW.tex}} &
			\resizebox{0.25\textwidth}{!}{\input{figures/coWR.tex}} &
			\resizebox{0.25\textwidth}{!}{\input{figures/coRW.tex}} &
			\resizebox{0.27\textwidth}{!}{\input{figures/coRR.tex}} \\
			\hline
		\end{tabular}
		\label{fig:como}
	\end{figure}
	
	
	\begin{itemize}[label=setmm,align=left,leftmargin=*]
		\item [$\setRF$] The relation is formed from write events 
			to read events, since fences cannot be both, the $\setRF$
			relations remains unchanged \ie $\rf{\imm{\tau}}{}{}$ =
			$\setRF$.
		
		\item [$\setRF^{-1}$] The relation remains unchanged as 
			$\setRF$ remains unchanged \ie $\rfinv{\imm{\tau}}{}{}$ 
			= $\setRF^{-1}$.
		
		\item [$\setMO$] Assume $\exists w, w' \in \events_\tau$ \st 
			as a consequence of synthesizing fences in the buggy trace 
			$\tau$ to form $\imm{\tau}$, $w$ is modification-ordered
			before $w'$. However, $(w,w') \nin \mo{\imm{\tau}}{}{}$
			since we consider $\mo{\imm{\tau}}{}{}$ = $\setMO$.
			
			We show by case analysis on the coherence conditions
			involving $\mo{\imm{\tau}}{}{}$ that \ourtechnique does
			not miss a weak cycle by not expanding modification-order
			after synthesizing fences.
		
			Consider the following coherence conditions involving 
			$\mo{\imm{\tau}}{}{}$:
		
			\begin{itemize}[label=CoWW,align=left,leftmargin=*]
			\item [CoWW:] Let $\exists w_1, w_2 \in \writes$
				\st $\hb{\imm{\tau}}{w_1}{w_2}$. 
			
				If $\mo{\tau}{w_1}{w_2}$ then there does not
				exist a violation.
			
				However, if $\mo{\tau}{w_2}{w_1}$ then we will 
				detect the violation as a cycle in 
				$\mo{\imm{\tau}}{}{};\hb{\imm{\tau}}{}{}$
				(depicted diagrammatically in \hlref{coWW}).
			
			\item [CoWR:] Let $\exists r_1 \in \reads$, 
				$\exists w_1,w_2 \in \writes$ 
				\st $\hb{\imm{\tau}}{w_1}{r_1}$ and 
					$\rf{\imm{\tau}}{w_2}{r_1}$.
			
				If $\mo{\tau}{w_1}{w_2}$ then there does not
				exist a violation.
			
				However, if $\mo{\tau}{w_2}{w_1}$ then we will 
				detect the violation as a cycle in 
				$\mo{\imm{\tau}}{}{};\hb{\imm{\tau}}{}{};\rfinv{\imm{\tau}}{}{}$
				(depicted diagrammatically in \hlref{coWR}).
				
			\item [CoRW:] Let $\exists r_1 \in \reads$, 
				$\exists w_1,w_2 \in \writes$ 
				\st $\rf{\imm{\tau}}{w_1}{r_1}$ and 
				$\hb{\imm{\tau}}{r_1}{w_2}$.
			
				If $\mo{\tau}{w_1}{w_2}$ then there does not
				exist a violation.
			
				However, if $\mo{\tau}{w_2}{w_1}$ then we will 
				detect the violation as a cycle in 
				$\mo{\imm{\tau}}{}{};\rf{\imm{\tau}}{}{};\hb{\imm{\tau}}{}{}$
				(depicted diagrammatically in \hlref{coRW}).
			
			\item [CoRR:] Let $\exists r_1,r_2 \in \reads$,
				$\exists w_1, w_2 \in \writes$
				\st $\rf{\imm{\tau}}{w_1}{r_1}$, 
					$\rf{\imm{\tau}}{w_2}{r_2}$ and
					$\hb{\imm{\tau}}{r_1}{r_2}$. 
					
					If $\mo{\tau}{w_1}{w_2}$ then there does not
					exist a violation.
					
					However, if $\mo{\tau}{w_2}{w_1}$ then we will 
					detect the violation as a cycle in 
					$\mo{\imm{\tau}}{}{};\rf{\imm{\tau}}{}{};\hb{\imm{\tau}}{}{};\rfinv{\imm{\tau}}{}{}$
					(depicted diagrammatically in \hlref{coRR}).
		\end{itemize}
	\end{itemize}

	Thus, \ourtechnique does not miss a cycle in any
	coherence rule and	\wkfence is sound.
\end{proof}

\noindent
\cc defines a total-order on \sc ordered events in agreement with
the $\setHB, \setMO, \setRF$ relations \cite{C11} \ie:\newline
Given $e^\sc_1, e^\sc_2 \in \ordevents{\sc}_\tau$ if 

$e^\sc_1$ $(\setHB \union \setMO \union \setRF \union \setFR)^+$ 
$e^\sc_2$; {\it or} \hfill[to1]

$e^\sc_1$ $R_1;R_2;...;R_n$ $e^\sc_2$, where 
$R_i \in \{\setHB, \setMO, \setRF, \setFR\}$.\hfill[to2]
\newline


\noindent
The relation $\setSO$ has been defined in 
Section~\ref{sec:invalidating ce} as follows:\newline
	$\forall e_1, e_2 \in \events_\tau$ \st 
	$(e_1,e_2) \in$ $\setHB$ $\union$ $\setMO$ $\union$ $\setRF$ 
	$\union$ $\setFR$ 
	
	if
	$e_1, e_2 \in \ordevents{\sc}_\tau$ then 
	$\so{\tau'}{e_1}{e_2}$; \hfill[so1]
	
	if
	$e_1 \in \ordevents{\sc}_\tau$, 
	$\exists \mathbb{F}^\sc \in \ordsfences{\sc}_{\tau'}$ where
	$\seqb{\tau'}{e_2}{\mathbb{F}^\sc}$ then
	$\so{\tau'}{e_1}{\mathbb{F}^\sc}$;
	\hfill[so2]
	
	if
	$e_2 \in \ordevents{\sc}_\tau$, 
	$\exists \mathbb{F}^\sc \in \ordsfences{\sc}_{\tau'}$ where
	$\seqb{\tau'}{\mathbb{F}^\sc}{e_1}$ then
	$\so{\tau'}{\mathbb{F}^\sc}{e_2}$;
	\hfill[so3]
	
	if
	$\exists \mathbb{F}^\sc_1$, $\mathbb{F}^\sc_2$ 
	$\in \ordsfences{\sc}_{\tau'}$ where
	$\seqb{\tau'}{\mathbb{F}^\sc_1}{e_1}$ and 
	$\seqb{\tau'}{e_2}{\mathbb{F}^\sc_2}$ then
	$\so{\tau'}{\mathbb{F}^\sc_1}{\mathbb{F}^\sc_1}$.
	\hfill[so4]


{\lemma {$\setSO \subseteq \setTO$ ($\setSO$ does not relate 
		two events that are not related by rules for $\setTO$)}}
\begin{proof}
		By definition of $\setSO$, $\so{\tau}{e^\sc_1}{e^\sc_2}$ if
		\begin{itemize}[label=so4,align=left,leftmargin=*]
			\item [so1:] $e^\sc_1, e^\sc_2 \in \ordevents{\sc}_\tau$
				and $(e^\sc_1, e^\sc_2) \in$ $\setHB$ $\union$ 
				$\setMO$ $\union$ $\setRF$ $\union$ $\setFR$
				
				$\implies$ $\to{\tau}{e^\sc_1}{e^\sc_2}$
				(using [to1]).
				
			\item [so2:] $e^\sc_1 \in \ordevents{\sc}_\tau$,
				$e^\sc_2 \in \ordfences{\sc}_\tau$
				and $(e^\sc_1, e^\sc_2) \in$ ($\setHB$ $\union$ 
				$\setMO$ $\union$ $\setRF$ $\union$ $\setFR$);$\setSB$
			
				$\implies$ $\to{\tau}{e^\sc_1}{e^\sc_2}$
				(using [to2] since $\setSB$ $\subseteq$ $\setHB$).
				
			\item [so3:] $e^\sc_2 \in \ordevents{\sc}_\tau$,
				$e^\sc_1 \in \ordfences{\sc}_\tau$
				and $(e^\sc_1, e^\sc_2) \in$ $\setSB$;($\setHB$ 
				$\union$ $\setMO$ $\union$ $\setRF$ $\union$ $\setFR$)
			
				$\implies$ $\to{\tau}{e^\sc_1}{e^\sc_2}$
				(using [to2] since $\setSB$ $\subseteq$ $\setHB$).
				
			\item [so2:] $e^\sc_1, e^\sc_2 \in \ordfences{\sc}_\tau$
				and $(e^\sc_1, e^\sc_2) \in$ $\setSB$;($\setHB$ $\union$ 
				$\setMO$ $\union$ $\setRF$ $\union$ $\setFR$);$\setSB$
			
				$\implies$ $\to{\tau}{e^\sc_1}{e^\sc_2}$
				(using [to2] since $\setSB$ $\subseteq$ $\setHB$).
		\end{itemize}
\end{proof}


{\theorem {\stfence is sound: if there does not exist a total order on
	the \sc ordered events of a trace $\tau$ then there exists a cycle 
	in $\setSO$.} \label{thm:strong-sound}}
\begin{proof}
	Consider $e^\sc_1, e^\sc_2 \in \ordevents{\sc}_\tau$ \st 
	both $\to{\tau}{e^\sc_1}{e^\sc_2}$ and 
	$\to{\tau}{e^\sc_2}{e^\sc_1}$ agree with the other event relations.
	To form the total order we can assume either one of the two orders
	\cite{C11}. Assume $\to{\tau}{e^\sc_1}{e^\sc_2}$.
	
	Further, consider a total order cannot be formed on \sc events of
	the intermediate trace $\imm{\tau}$ \st
	$\to{\imm{\tau}}{e}{\to{\imm{\tau}}{...}{\to{\imm{\tau}}{e^\sc_1}{\to{\imm{\tau}}{e^\sc_2}{\to{\imm{\tau}}{...}{e}}}}}$
	then we simply reverse to $\to{\imm{\tau}}{e^\sc_2}{e^\sc_1}$ and
	eliminate the cycle.
	
	Thus, pairs of \sc ordered events that don't have a fixed order
	cannot contribute to a strong cycle. \hfill{\it inf}(i).
	
	Given $e^\sc_1, e^\sc_2 \in \ordevents{\sc}_{\imm{\tau}}$
	$\to{\imm{\tau}}{e^\sc_1}{e^\sc_2}$ if 
	\begin{itemize}[label=to2,align=left,leftmargin=*]
		\item [to1:] $(e^\sc_1, e^\sc_2) \in$ $\setHB$ $\union$ 
			$\setMO$ $\union$ $\setRF$ $\union$ $\setFR$
		
			$\implies$ $\so{\imm{\tau}}{e^\sc_1}{e^\sc_2}$
			(using [so1]).
			
			Thus, such events are related by $\so{\imm{\tau}}{}{}$
			and would be considered by finding strong cycles.
		
		\item [to2:] $e^\sc_1$ $R_1;R_2;...;R_n$ $e^\sc_2$, where 
			$R_i \in \{\setHB, \setMO, \setRF, \setFR\}$.
			
			It may be the case that $\nso{\imm{\tau}}{e^\sc_1}{e^\sc_2}$
			because [so2], [so3] and [so4] only cover a subset of such 
			cases. However, if
			\begin{enumerate}
				\item if $e^\sc_1 \neq e^\sc_2$ then there is no cycle;
				\item if $e^\sc_1 = e^\sc_2$ then the cycle violates a
					coherence condition and a corresponding weak cycle
					would be detected.
			\end{enumerate}
	\end{itemize}
	Thus, cycles created due to [to2] are not strong cycles and
	$\so{\imm{\tau}}{}{}$ relates events related by $\to{\imm{\tau}}{}{}$
	using [to1].\hfill{\it inf}(ii).
	
	Thus, from {\it inf}(i) and (ii), \stfence is sound.
\end{proof}

{\lemma {\ourtechnique synthesizes the optimal number of fences.}}
\begin{proof}
	Let $\mathcal{F}$ represent the set of fences synthesized by
	\ourtechnique and let $\mathcal{F}^o$ represent the optimal set
	of fences. Assume $|\mathcal{F}^o| < |\mathcal{F}|$.
	
	The min-model of the non-optimal solution is computed using a
	SAT solver (\z) and is assumed to be correct. As the consequence,
	$|\mathcal{F}^o| < |\mathcal{F}|$ $\implies$ the optimal result
	was not a part of the SAT query formula.
	
	Using Theorem~\ref{thm:weak-sound} and 
	Theorem~\ref{thm:strong-sound} we know that \ourtechnique does 
	not miss any weak or strong cycle
	$\implies$ every set of fences that forms a correct solution,
	including the optimal solution, is contained in the SAT query
	formula.
	
	Thus, by contradiction, $|\mathcal{F}| = |\mathcal{F}|^o$ \ie
	\ourtechnique synthesizes the optimal number of fences.
\end{proof}