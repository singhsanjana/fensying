{\lemma {\wkfence is sound: If there exists a violation of a 
	coherence condition then \wkfence detects a corresponding cycle} 
	\label{lem:weak-sound}}
\begin{proof}
	\wkfence strategy checks the validity of coherence conditions
	on event relations between program events and synthesized
	fences.
	
	Given a buggy trace $\tau$, we get the relations $\setHB$,
	$\setRF$, $\setMO$ and $\setRF^{-1}$ from the counter
	example generator.
	(Note that $\setFR$ relation is not invoked by any 
	coherence condition.)
	
	We compute the $\hb{\imm{\tau}}{}{}$ relation after introducing 
	the synthesized fences in the intermediate trace $\imm{\tau}$, 
	hence, the soundness condition can be defined as: 
	\ourtechnique soundly detects all weak cycle without modifying 
	$\setRF$, $\setMO$ and $\setRF^{-1}$ relations for the events of 
	$\imm{\tau}$ (\ie $\rf{\imm{\tau}}{}{} = \setRF$, 
	$\mo{\imm{\tau}}{}{} = \setMO$ and $\rfinv{\imm{\tau}}{}{} = 
	\setRF^{-1}$).
	
	\begin{figure}[h]
		\begin{tabular}{|c|c|c|c|}
			\hline
			\resizebox{0.19\textwidth}{!}{\input{figures/coWW.tex}} &
			\resizebox{0.25\textwidth}{!}{\input{figures/coWR.tex}} &
			\resizebox{0.25\textwidth}{!}{\input{figures/coRW.tex}} &
			\resizebox{0.27\textwidth}{!}{\input{figures/coRR.tex}} \\
			\hline
		\end{tabular}
		\label{fig:como}
	\end{figure}
	
	
	\begin{itemize}[label=setmm,align=left,leftmargin=*]
		\item [$\setRF$] The relation is formed from write events 
			to read events, since fences cannot be both, the $\setRF$
			relations remains unchanged \ie $\rf{\imm{\tau}}{}{}$ =
			$\setRF$.
		
		\item [$\setRF^{-1}$] The relation remains unchanged as 
			$\setRF$ remains unchanged \ie $\rfinv{\imm{\tau}}{}{}$ 
			= $\setRF^{-1}$.
		
		\item [$\setMO$] Assume $\exists w, w' \in \events_\tau$ \st 
			as a consequence of synthesizing fences in the buggy trace 
			$\tau$ to form $\imm{\tau}$, $w$ is modification-ordered
			before $w'$. However, $(w,w') \nin \mo{\imm{\tau}}{}{}$
			since we consider $\mo{\imm{\tau}}{}{}$ = $\setMO$.
			
			We show by case analysis on the coherence conditions
			involving $\mo{\imm{\tau}}{}{}$ that \ourtechnique does
			not miss a weak cycle by not expanding modification-order
			after synthesizing fences.
		
			Consider the following coherence conditions involving 
			$\mo{\imm{\tau}}{}{}$:
		
			\begin{itemize}[label=CoWW,align=left,leftmargin=*]
			\item [CoWW:] Let $\exists w_1, w_2 \in \writes$
				\st $\hb{\imm{\tau}}{w_1}{w_2}$. 
			
				If $\mo{\tau}{w_1}{w_2}$ then there does not
				exist a violation.
			
				However, if $\mo{\tau}{w_2}{w_1}$ then we will 
				detect the violation as a cycle in 
				$\mo{\imm{\tau}}{}{};\hb{\imm{\tau}}{}{}$
				(depicted diagrammatically in \hlref{coWW}).
			
			\item [CoWR:] Let $\exists r_1 \in \reads$, 
				$\exists w_1,w_2 \in \writes$ 
				\st $\hb{\imm{\tau}}{w_1}{r_1}$ and 
					$\rf{\imm{\tau}}{w_2}{r_1}$.
			
				If $\mo{\tau}{w_1}{w_2}$ then there does not
				exist a violation.
			
				However, if $\mo{\tau}{w_2}{w_1}$ then we will 
				detect the violation as a cycle in 
				$\mo{\imm{\tau}}{}{};\hb{\imm{\tau}}{}{};\rfinv{\imm{\tau}}{}{}$
				(depicted diagrammatically in \hlref{coWR}).
				
			\item [CoRW:] Let $\exists r_1 \in \reads$, 
				$\exists w_1,w_2 \in \writes$ 
				\st $\rf{\imm{\tau}}{w_1}{r_1}$ and 
				$\hb{\imm{\tau}}{r_1}{w_2}$.
			
				If $\mo{\tau}{w_1}{w_2}$ then there does not
				exist a violation.
			
				However, if $\mo{\tau}{w_2}{w_1}$ then we will 
				detect the violation as a cycle in 
				$\mo{\imm{\tau}}{}{};\rf{\imm{\tau}}{}{};\hb{\imm{\tau}}{}{}$
				(depicted diagrammatically in \hlref{coRW}).
			
			\item [CoRR:] Let $\exists r_1,r_2 \in \reads$,
				$\exists w_1, w_2 \in \writes$
				\st $\rf{\imm{\tau}}{w_1}{r_1}$, 
					$\rf{\imm{\tau}}{w_2}{r_2}$ and
					$\hb{\imm{\tau}}{r_1}{r_2}$. 
					
					If $\mo{\tau}{w_1}{w_2}$ then there does not
					exist a violation.
					
					However, if $\mo{\tau}{w_2}{w_1}$ then we will 
					detect the violation as a cycle in 
					$\mo{\imm{\tau}}{}{};\rf{\imm{\tau}}{}{};\hb{\imm{\tau}}{}{};\rfinv{\imm{\tau}}{}{}$
					(depicted diagrammatically in \hlref{coRR}).
		\end{itemize}
	\end{itemize}

	Thus, \ourtechnique does not miss a cycle in any
	coherence rule and	\wkfence is sound.
\end{proof}

\noindent
\cc defines a total-order on \sc ordered events in agreement with
the $\setHB$, $\setMO$, $\setRF$ relations \cite{C11} \ie:\newline
Given $e^\sc_1, e^\sc_2 \in \ordevents{\sc}_\tau$,
$\to{\tau}{e^\sc_1}{e^\sc_2}$ if 
$e^\sc_1$ $(\setHB \union \setMO \union \setRF \union \setFR)^+$ 
$e^\sc_2$. \hfill[to]
\newline


\noindent
The relation $\setSO$ has been defined in 
Section~\ref{sec:invalidating ce} as follows:\newline
	$\forall e_1, e_2 \in \events_\tau$ \st 
	$(e_1,e_2) \in$ $\setHB$ $\union$ $\setMO$ $\union$ $\setRF$ 
	$\union$ $\setFR$ 
	
	if
	$e_1, e_2 \in \ordevents{\sc}_\tau$ then 
	$\so{\tau'}{e_1}{e_2}$; \hfill[so1]
	
	if
	$e_1 \in \ordevents{\sc}_\tau$, 
	$\exists \mathbb{F}^\sc \in \ordsfences{\sc}_{\tau'}$ where
	$\seqb{\tau'}{e_2}{\mathbb{F}^\sc}$ then
	$\so{\tau'}{e_1}{\mathbb{F}^\sc}$;
	\hfill[so2]
	
	if
	$e_2 \in \ordevents{\sc}_\tau$, 
	$\exists \mathbb{F}^\sc \in \ordsfences{\sc}_{\tau'}$ where
	$\seqb{\tau'}{\mathbb{F}^\sc}{e_1}$ then
	$\so{\tau'}{\mathbb{F}^\sc}{e_2}$;
	\hfill[so3]
	
	if
	$\exists \mathbb{F}^\sc_1$, $\mathbb{F}^\sc_2$ 
	$\in \ordsfences{\sc}_{\tau'}$ where
	$\seqb{\tau'}{\mathbb{F}^\sc_1}{e_1}$ and 
	$\seqb{\tau'}{e_2}{\mathbb{F}^\sc_2}$ then
	$\so{\tau'}{\mathbb{F}^\sc_1}{\mathbb{F}^\sc_1}$.
	\hfill[so4]


{\lemma {$\setSO \subseteq \setTO$ ($\setSO$ does not relate 
		two events that are not related by rules for $\setTO$)}
	\label{lem:so subset to}}
\begin{proof}
		By definition of $\setSO$, $\so{\tau}{e^\sc_1}{e^\sc_2}$ if
		\begin{itemize}[label=so4,align=left,leftmargin=*]
			\item [so1:] $e^\sc_1, e^\sc_2 \in \ordevents{\sc}_\tau$
				and $(e^\sc_1, e^\sc_2) \in$ $\setHB$ $\union$ 
				$\setMO$ $\union$ $\setRF$ $\union$ $\setFR$
				
				$\implies$ $\to{\tau}{e^\sc_1}{e^\sc_2}$
				(using [to]).
				
			\item [so2:] $e^\sc_1 \in \ordevents{\sc}_\tau$,
				$e^\sc_2 \in \ordfences{\sc}_\tau$
				and $(e^\sc_1, e^\sc_2) \in$ ($\setHB$ $\union$ 
				$\setMO$ $\union$ $\setRF$ $\union$ $\setFR$);$\setSB$
			
				$\implies$ $\to{\tau}{e^\sc_1}{e^\sc_2}$
				(using [to] since $\setSB$ $\subseteq$ $\setHB$).
				
			\item [so3:] $e^\sc_2 \in \ordevents{\sc}_\tau$,
				$e^\sc_1 \in \ordfences{\sc}_\tau$
				and $(e^\sc_1, e^\sc_2) \in$ $\setSB$;($\setHB$ 
				$\union$ $\setMO$ $\union$ $\setRF$ $\union$ $\setFR$)
			
				$\implies$ $\to{\tau}{e^\sc_1}{e^\sc_2}$
				(using [to] since $\setSB$ $\subseteq$ $\setHB$).
				
			\item [so2:] $e^\sc_1, e^\sc_2 \in \ordfences{\sc}_\tau$
				and $(e^\sc_1, e^\sc_2) \in$ $\setSB$;($\setHB$ $\union$ 
				$\setMO$ $\union$ $\setRF$ $\union$ $\setFR$);$\setSB$
			
				$\implies$ $\to{\tau}{e^\sc_1}{e^\sc_2}$
				(using [to] since $\setSB$ $\subseteq$ $\setHB$).
		\end{itemize}
\end{proof}


{\lemma {\stfence is sound: if there does not exist a total order on
	the \sc ordered events of a trace $\tau$ then there exists a cycle 
	in $\setSO$.} \label{lem:strong-sound}}
\begin{proof}
	Consider $e^\sc_1, e^\sc_2 \in \ordevents{\sc}_\tau$ \st 
	both $\to{\tau}{e^\sc_1}{e^\sc_2}$ and 
	$\to{\tau}{e^\sc_2}{e^\sc_1}$ agree with the other event relations.
	To form the total order we can assume either one of the two orders
	\cite{C11}. Assume $\to{\tau}{e^\sc_1}{e^\sc_2}$.
	
	Further, consider a total order cannot be formed on \sc events of
	the intermediate trace $\imm{\tau}$ \st
	$\to{\imm{\tau}}{e}{\to{\imm{\tau}}{...}{\to{\imm{\tau}}{e^\sc_1}{\to{\imm{\tau}}{e^\sc_2}{\to{\imm{\tau}}{...}{e}}}}}$
	then we simply reverse to $\to{\imm{\tau}}{e^\sc_2}{e^\sc_1}$ and
	eliminate the cycle.
	
	Thus, pairs of \sc ordered events that don't have a fixed order
	cannot contribute to a strong cycle. \hfill{\it inf}(i).
	
	Given $e^\sc_1, e^\sc_2 \in \ordevents{\sc}_{\imm{\tau}}$
	$\to{\imm{\tau}}{e^\sc_1}{e^\sc_2}$ if 
	\begin{itemize}[label=to2,align=left,leftmargin=*]
		\item [to1:] $(e^\sc_1, e^\sc_2) \in$ $\setHB$ $\union$ 
			$\setMO$ $\union$ $\setRF$ $\union$ $\setFR$
		
			$\implies$ $\so{\imm{\tau}}{e^\sc_1}{e^\sc_2}$
			(using [so1]).
			
			Thus, such events are related by $\so{\imm{\tau}}{}{}$
			and would be considered by finding strong cycles.
		
		\item [to2:] $e^\sc_1$ $R_1;R_2;...;R_n$ $e^\sc_2$, where 
			$R_i \in \{\setHB, \setMO, \setRF, \setFR\}$.
			
			It may be the case that $\nso{\imm{\tau}}{e^\sc_1}{e^\sc_2}$
			because [so2], [so3] and [so4] only cover a subset of such 
			cases. However, if
			\begin{enumerate}
				\item if $e^\sc_1 \neq e^\sc_2$ then there is no cycle;
				\item if $e^\sc_1 = e^\sc_2$ then the cycle violates a
					coherence condition and a corresponding weak cycle
					would be detected.
			\end{enumerate}
	\end{itemize}
	Thus, cycles created due to [to2] are not strong cycles and
	$\so{\imm{\tau}}{}{}$ relates events related by $\to{\imm{\tau}}{}{}$
	using [to1].\hfill{\it inf}(ii).
	
	Thus, from {\it inf}(i) and (ii) and Lemma~\ref{lem:so subset to}, 
	\stfence is sound.
\end{proof}

{\lemma {{\tt AssignMO} is sound: \ourtechnique does not assign a memory
	order to a fence that is too weak to stop the buggy trace.}
	\label{lem:mo-sound}}
\begin{proof}
	By definition of \hlref{coherence conditions} if there exists
	a weak cycle in the intermediate trace $\imm{\tau}$ then 
	$\exists$ $\sw{\imm{\tau}}{e}{e'}$ $\v$ 
	$\dob{\imm{\tau}}{e}{e'}$. 
	
	Since, the buggy trace $\tau$ was returned by the counter
	example generators 
	
	$\implies$ $\neg\sw{\tau}{e}{e'}$ $\^$
	$\neg\dob{\tau}{e}{e'}$
	
	$\implies$ either $e$ or $e'$ or both are candidate fences 
	introduced by \ourtechnique.
	
	By definitions of $\sw{\imm{\tau}}{e}{e'}$ and 
	$\dob{\imm{\tau}}{e}{e'}$
	if $e$ is a fence then its memory order must be \rel or 
	stricter, if $e'$ is a fence then its memory order must be 
	\acq or stronger.
	
	Thus, the locally assigned memory orders are sufficiently 
	strong.\hfill{\it inf}(i)\newline
	
	\noindent
	If there exists a fence, $\mathbb{F}$,  that was locally 
	assigned a memory order $m$ and after coalescing with other 
	buggy trace the final memory order of $\mathbb{F}$ is $m'$
	then either $m' = m$ or $m'$ is stronger than $m$
	(by construction).
	
	\noindent
	Since from {\it inf}(i) we know that $m$ was sufficiently 
	strong then final memory order $m'$ is also sufficiently strong. 
	
\end{proof}

{\theorem {\ourtechnique is sound: If a buggy trace can be stopped 
		by synthesizing \cc fences and \ourtechnique stops the trace.}}
\begin{proof}
	Consider induction on the number of buggy traces. 
	Let {\tt CE} represent the set of counter examples or buggy traces.
	
	\noindent
	{\sl Base Case:} Consider $|${\tt CE}$|$ = 1. 
	Using Lemma~\ref{lem:weak-sound} and Lemma~\ref{lem:strong-sound}
	we can state that a violation in \hlref{coherence conditions} or
	\sc total order is not missed by \ourtechnique. \newline
	%	
	Further the fences introduced for at least 1 of the violations
	exist in the final solution (by construction of SAT query).
	\newline
	%
	Hence, \ourtechnique is sound for 1 trace.\newline
	
	\noindent 
	{\sl Induction Hypothesis:}
	Assume that \ourtechnique is sound for $|${\tt CE}$|$ = N.
	\newline
	
	\noindent
	{\sl Induction Step:}
	Consider $|${\tt CE}$|$ = N+1.
	
	Since, we take a conjunction on the SAT formulas from various
	traces thus at least 1 cycle from each trace exists in the 
	{\tt min-model} (by construction of SAT query).\newline
	%
	Further, we know from Lemma~\ref{lem:mo-sound} that \ourtechnique
	assigns memory orders that can stop all the corresponding traces.
	\newline
	%
	Thus, \ourtechnique is sound for N+1 buggy traces.
\end{proof}

{\lemma {{\tt min-model} returns the optimal number of fences.}
	\label{lem:opt-num}}
\begin{proof}
	Let $\mathcal{F}$ represent the set of fences returned by
	{\tt min-model} and let $\mathcal{F}^o$ represent the optimal set
	of fences. Assume $|\mathcal{F}^o| < |\mathcal{F}|$.
	
	The min-model of the non-optimal solution is computed using a
	SAT solver (\z) and the computation is assumed to be correct. 
	As the consequence,
	$|\mathcal{F}^o| < |\mathcal{F}|$ $\implies$ the optimal result
	was not a part of the SAT query formula.
	
	Using Lemma~\ref{lem:weak-sound} and 
	Lemma~\ref{lem:strong-sound} we know that \ourtechnique does 
	not miss any weak or strong cycle
	$\implies$ every set of fences that forms a correct solution,
	including the optimal solution, is contained in the SAT query
	formula.
	
	Thus, by contradiction, $|\mathcal{F}| = |\mathcal{F}|^o$ 
	\ie {\tt min-model} returns the optimal number of fences.
\end{proof}

{\theorem {\ourtechnique synthesizes the optimal number of fences
	with the optimal memory orders.}}
\begin{proof}
	Let {\tt min-cycles} represent the set of weak and strong 
	cycles of all buggy traces \st every candidate fence in the 
	cycle belongs to {\tt min$\Phi$}. 
	
	We know that {\tt AssignMO} iterates over cycles in {\tt 
	min-cycles} and takes union over fences of cycles from 
	{\tt min-cycles}. As {\tt min$\Phi$} consists of the optimal
	number of fences (Lemma~\ref{lem:opt-num}) then union over
	cycles of {\tt min-cycles} has the same set of fences as
	{\tt min$\Phi$}.\newline
	Thus, \ourtechnique is optimal in the number of fences.
	\newline
	
	Consider induction on the number of counter examples or buggy
	traces {\tt CE}.\newline
	
	\noindent
	{\sl Base Case-1:} Consider $|${\tt CE}$|$ = 1.
	By definition of {\tt AssignMO} each fence is locally assigned
	the weakest memory order that is sound (Lemma~\ref{lem:mo-sound}).

	Thus, \ourtechnique is optimal in the memory order of fences
	for 1 buggy trace.
	\newline
	
	\noindent
	{\sl Base Case-2:} Consider $|${\tt CE}$|$ = 2.
	Let $\tau_1c_i$ for $i \in \{1...M_1\}$ represent the $M_1$
	cycles of trace $\tau_1$ and 
	let $\tau_2c_j$ for $j \in \{1...M_2\}$ represent the $M_2$
	cycles of trace $\tau_2$.
	Further, let $\tau_1c_i-\tau_2c_j$ represent the coalesce of 
	cycles $\tau_1c_i$ and $\tau_2c_j$.
	
	Each coalesced solutions has the same number of fences = 
	fences of {\tt min$\Phi$} because {\tt min$\Phi$} returns the
	minimum number of fences required to stop $\tau_1$ and $\tau_2$.
	
	\noindent
	If $\exists \mathbb{F}$ fence with memory order $m$ in a 
	cycle $\tau_1c_i$ but the final solution of \ourtechnique
	assigns memory order $m'$ to $\mathbb{F}$ \st $m'$ is stronger
	than $m$
	
	then, $\exists \tau_2c_j$ where memory order of $\mathbb{F}$ is
	$m'$ (by construction of coalesced solutions),
	
	further, $\nexists \tau_2c_k$ where memory order of $\mathbb{F}$
	is $m$ \st $score(\tau_1c_i-\tau_2c_k) < score(\tau_1c_i-\tau_2c_j)$
	(where $score(x)$ represents the score of the solution $x$).
	
	Thus, \ourtechnique is optimal in the memory order of fences
	for 2 buggy traces.
	\newline 
	
	\noindent
	{\sl Induction Hypothesis:} Assume, \ourtechnique is optimal in the 
	memory order of fences for N buggy trace.
	\newline
	
	\noindent
	{\sl Induction Step:} 
	Consider $|${\tt CE}$|$ = N+1.
	Let $s_1, ..., s_M$ represent the $M$ coalesced solutions for 
	buggy traces $\tau_1, ..., \tau_N$ and $\tau_{N+1}c_i$ for 
	$i \in \{1, ..., P \}$ represent the $P$ cycles of $(N+1)^{th}$
	trace.
	
	Every coalesced solution $\tau_{N+1}s_j$ has the same number of 
	fences = fences of {\tt min$\Phi$} because {\tt min$\Phi$} 
	returns the minimum number of fences required to stop 
	$\tau_1, ..., \tau_{N+1}$.
	
	If $\exists \mathbb{F}$ fence with memory order $m$ in a 
	cycle $\tau_{N+1}c_i$ but the final solution of \ourtechnique
	assigns memory order $m'$ to $\mathbb{F}$ \st $m'$ is stronger
	than $m$
	
	then, $\exists s_j$ where memory order of $\mathbb{F}$ is
	$m'$ (by construction of coalesced solutions),
	
	further, $\nexists s_k$ where memory order of $\mathbb{F}$
	is $m$ \st $score(\tau_{N+1}c_i-s_k) < score(\tau_{N+1}c_i-s_j)$
	(where $score(x)$ represents the score of the solution $x$).
	
	Thus, \ourtechnique is optimal in the memory order of fences
	for N+1 buggy traces.
\end{proof}